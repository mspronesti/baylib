\hypertarget{logic__sampling_8hpp_source}{}\doxysection{logic\+\_\+sampling.\+hpp}
\label{logic__sampling_8hpp_source}\index{/home/mspronesti/Desktop/baylib/baylib/inference/logic\_sampling.hpp@{/home/mspronesti/Desktop/baylib/baylib/inference/logic\_sampling.hpp}}
\mbox{\hyperlink{logic__sampling_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//}}
\DoxyCodeLine{2 \textcolor{comment}{// Created by elle on 22/07/21.}}
\DoxyCodeLine{3 \textcolor{comment}{//}}
\DoxyCodeLine{4 }
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef BAYLIB\_LOGIC\_SAMPLING\_HPP}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define BAYLIB\_LOGIC\_SAMPLING\_HPP}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#define CL\_TARGET\_OPENCL\_VERSION 220}}
\DoxyCodeLine{9 }
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <vector>}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include <boost/compute.hpp>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include <boost/compute/device.hpp>}}
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{abstract__inference__algorithm_8hpp}{baylib/inference/abstract\_inference\_algorithm.hpp}}>}}
\DoxyCodeLine{17 }
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacebn}{bn}} \{}
\DoxyCodeLine{22     \textcolor{keyword}{namespace }inference\{}
\DoxyCodeLine{23         \textcolor{keyword}{namespace }compute = boost::compute;}
\DoxyCodeLine{24         \textcolor{keyword}{using} boost::compute::lambda::\_1;}
\DoxyCodeLine{25         \textcolor{keyword}{using} boost::compute::lambda::\_2;}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 }
\DoxyCodeLine{42         \textcolor{keyword}{template} <\textcolor{keyword}{typename} Probability>}
\DoxyCodeLine{43         \textcolor{keyword}{class }\mbox{\hyperlink{classbn_1_1inference_1_1logic__sampling}{logic\_sampling}} : \textcolor{keyword}{public} \mbox{\hyperlink{classbn_1_1inference_1_1vectorized__inference__algorithm}{vectorized\_inference\_algorithm}}<Probability>\{}
\DoxyCodeLine{44             \textcolor{keyword}{using} prob\_v = boost::compute::vector<Probability>;}
\DoxyCodeLine{45         \textcolor{keyword}{public}:}
\DoxyCodeLine{46 }
\DoxyCodeLine{47             \mbox{\hyperlink{classbn_1_1inference_1_1logic__sampling}{logic\_sampling}}(}
\DoxyCodeLine{48                     ulong samples,}
\DoxyCodeLine{49                     \textcolor{keywordtype}{size\_t} memory,}
\DoxyCodeLine{50                     uint seed = 0,}
\DoxyCodeLine{51                     \textcolor{keyword}{const} compute::device \&device = compute::system::default\_device()}
\DoxyCodeLine{52             )}
\DoxyCodeLine{53             : \mbox{\hyperlink{classbn_1_1inference_1_1vectorized__inference__algorithm}{vectorized\_inference\_algorithm<Probability>}}(samples, memory, seed, device)}
\DoxyCodeLine{54             \{ \}}
\DoxyCodeLine{55 }
\DoxyCodeLine{56 }
\DoxyCodeLine{57 }
\DoxyCodeLine{58             \mbox{\hyperlink{classbn_1_1marginal__distribution}{marginal\_distribution<Probability>}} \mbox{\hyperlink{classbn_1_1inference_1_1logic__sampling_a54b21ea8cc491b377366b08003985867}{make\_inference}} (}
\DoxyCodeLine{59                     \textcolor{keyword}{const} \mbox{\hyperlink{classbn_1_1bayesian__network}{bn::bayesian\_network<Probability>}} \&\mbox{\hyperlink{namespacebn}{bn}}}
\DoxyCodeLine{60             )}
\DoxyCodeLine{61             \{}
\DoxyCodeLine{62                 BAYLIB\_ASSERT(std::all\_of(\mbox{\hyperlink{namespacebn}{bn}}.begin(), \mbox{\hyperlink{namespacebn}{bn}}.end(),}
\DoxyCodeLine{63                                           [](\textcolor{keyword}{auto} \&var)\{ return bn::cpt\_filled\_out(var); \}),}
\DoxyCodeLine{64                               \textcolor{stringliteral}{"{}conditional probability tables must be properly filled to"{}}}
\DoxyCodeLine{65                               \textcolor{stringliteral}{"{} run logic\_sampling inference algorithm"{}},}
\DoxyCodeLine{66                               std::runtime\_error);}
\DoxyCodeLine{67 }
\DoxyCodeLine{68                 \textcolor{keyword}{auto} [iter\_samples, niter] = this-\/>\mbox{\hyperlink{classbn_1_1inference_1_1vectorized__inference__algorithm_a668209d974d4e5ec5eb96566bd64d27f}{calculate\_iterations}}(bn);}
\DoxyCodeLine{69                 \textcolor{keyword}{auto} vertex\_queue = \mbox{\hyperlink{namespacebn_a3d7493f846b1dc83dfff870d49bc558e}{bn::sampling\_order}}(\mbox{\hyperlink{namespacebn}{bn}});}
\DoxyCodeLine{70                 \mbox{\hyperlink{classbn_1_1marginal__distribution}{marginal\_distribution<Probability>}} marginal\_result(\mbox{\hyperlink{namespacebn}{bn}}.begin(), \mbox{\hyperlink{namespacebn}{bn}}.end());}
\DoxyCodeLine{71                 \textcolor{keywordflow}{for} (ulong i = 0; i< niter; i++) \{}
\DoxyCodeLine{72 }
\DoxyCodeLine{73                     std::vector<bcvec> result\_container(vertex\_queue.size());}
\DoxyCodeLine{74                     \mbox{\hyperlink{classbn_1_1marginal__distribution}{marginal\_distribution<Probability>}} temp(\mbox{\hyperlink{namespacebn}{bn}}.begin(), \mbox{\hyperlink{namespacebn}{bn}}.end());}
\DoxyCodeLine{75                     compute::vector<int> valid\_evidence\_vec(this-\/>nsamples, \textcolor{keyword}{true}, this-\/>queue);}
\DoxyCodeLine{76 }
\DoxyCodeLine{77                     \textcolor{keywordflow}{for}(ulong v : vertex\_queue) \{}
\DoxyCodeLine{78 }
\DoxyCodeLine{79                         std::vector<bcvec*> parents\_result;}
\DoxyCodeLine{80 }
\DoxyCodeLine{81                         \textcolor{comment}{// Build parents result vector in the correct order}}
\DoxyCodeLine{82                         \textcolor{keyword}{auto} parents = \mbox{\hyperlink{namespacebn}{bn}}[v].parents\_info.names();}
\DoxyCodeLine{83                         std::reverse(parents.begin(), parents.end());}
\DoxyCodeLine{84                         \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} p : parents) \{}
\DoxyCodeLine{85                             parents\_result.push\_back(\&result\_container[\mbox{\hyperlink{namespacebn}{bn}}.index\_of(p)]);}
\DoxyCodeLine{86                         \}}
\DoxyCodeLine{87 }
\DoxyCodeLine{88                         result\_container[v] = this-\/>\mbox{\hyperlink{classbn_1_1inference_1_1vectorized__inference__algorithm_a4af003210116dd1b40a1ba28a5c97c39}{simulate\_node}}(bn[v].table(), parents\_result, iter\_samples);}
\DoxyCodeLine{89 }
\DoxyCodeLine{90                         \textcolor{keywordflow}{if}(\mbox{\hyperlink{namespacebn}{bn}}[v].is\_evidence())\{}
\DoxyCodeLine{91                             compute::transform( result\_container[v].state.begin()}
\DoxyCodeLine{92                                                ,result\_container[v].state.end()}
\DoxyCodeLine{93                                                ,valid\_evidence\_vec.begin()}
\DoxyCodeLine{94                                                ,valid\_evidence\_vec.begin()}
\DoxyCodeLine{95                                                ,(\_1 == \mbox{\hyperlink{namespacebn}{bn}}[v].evidence\_state()) \&\& \_2}
\DoxyCodeLine{96                                                ,this-\/>queue);}
\DoxyCodeLine{97                         \}}
\DoxyCodeLine{98                     \}}
\DoxyCodeLine{99 }
\DoxyCodeLine{100                     \textcolor{keywordflow}{for}(ulong v : vertex\_queue) \{}
\DoxyCodeLine{101                         \textcolor{keyword}{auto} accumulated\_result = \mbox{\hyperlink{classbn_1_1inference_1_1logic__sampling_a848ba491bf69cb1ce23493bcd550efd2}{compute\_result\_general}}(result\_container[v], valid\_evidence\_vec);}
\DoxyCodeLine{102                         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} ix=0; ix< accumulated\_result.size(); ix++)}
\DoxyCodeLine{103                             marginal\_result[v][ix] += accumulated\_result[ix];}
\DoxyCodeLine{104                     \}}
\DoxyCodeLine{105                 \}}
\DoxyCodeLine{106                 marginal\_result.normalize();}
\DoxyCodeLine{107                 \textcolor{keywordflow}{return} marginal\_result;}
\DoxyCodeLine{108             \}}
\DoxyCodeLine{109 }
\DoxyCodeLine{110 }
\DoxyCodeLine{111         \textcolor{keyword}{private}:}
\DoxyCodeLine{112 }
\DoxyCodeLine{118             std::vector<ulong> \mbox{\hyperlink{classbn_1_1inference_1_1logic__sampling_a848ba491bf69cb1ce23493bcd550efd2}{compute\_result\_general}}(}
\DoxyCodeLine{119                     \mbox{\hyperlink{structbn_1_1bcvec}{bcvec}}\& res,}
\DoxyCodeLine{120                     compute::vector<int>\& valid}
\DoxyCodeLine{121             )}
\DoxyCodeLine{122             \{}
\DoxyCodeLine{123                 compute::transform( res.state.begin()}
\DoxyCodeLine{124                                    ,res.state.end()}
\DoxyCodeLine{125                                    ,valid.begin()}
\DoxyCodeLine{126                                    ,res.state.begin()}
\DoxyCodeLine{127                                    ,(\_1+1)*\_2}
\DoxyCodeLine{128                                    ,this-\/>queue);}
\DoxyCodeLine{129                 std::vector<ulong> acc\_res(res.cardinality);}
\DoxyCodeLine{130                 \textcolor{keywordflow}{for} (bn::state\_t i = 0; i < res.cardinality; ++i) \{}
\DoxyCodeLine{131                     acc\_res[i] = compute::count(res.state.begin(), res.state.end(), i+1, this-\/>queue);}
\DoxyCodeLine{132                 \}}
\DoxyCodeLine{133                 \textcolor{keywordflow}{return} acc\_res;}
\DoxyCodeLine{134             \}}
\DoxyCodeLine{135         \};}
\DoxyCodeLine{136     \} \textcolor{comment}{// namespace inference}}
\DoxyCodeLine{137 \} \textcolor{comment}{// namespace bn}}
\DoxyCodeLine{138 }
\DoxyCodeLine{139 }
\DoxyCodeLine{140 \textcolor{preprocessor}{\#endif }\textcolor{comment}{//BAYLIB\_LOGIC\_SAMPLING\_HPP}}

\end{DoxyCode}
