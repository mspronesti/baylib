\hypertarget{likelihood__weighting_8hpp_source}{}\doxysection{likelihood\+\_\+weighting.\+hpp}
\label{likelihood__weighting_8hpp_source}\index{/home/mspronesti/Desktop/baylib/baylib/inference/likelihood\_weighting.hpp@{/home/mspronesti/Desktop/baylib/baylib/inference/likelihood\_weighting.hpp}}
\mbox{\hyperlink{likelihood__weighting_8hpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{//}}
\DoxyCodeLine{2 \textcolor{comment}{// Created by elle on 30/08/21.}}
\DoxyCodeLine{3 \textcolor{comment}{//}}
\DoxyCodeLine{4 }
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef BAYLIB\_LIKELIHOOD\_WEIGHTING\_HPP}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define BAYLIB\_LIKELIHOOD\_WEIGHTING\_HPP}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <random>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <future>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{random__generator_8hpp}{baylib/tools/random/random\_generator.hpp}}>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <\mbox{\hyperlink{abstract__inference__algorithm_8hpp}{baylib/inference/abstract\_inference\_algorithm.hpp}}>}}
\DoxyCodeLine{12 }
\DoxyCodeLine{15 }
\DoxyCodeLine{16 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacebn}{bn}} \{}
\DoxyCodeLine{17     \textcolor{keyword}{namespace  }inference \{}
\DoxyCodeLine{28         \textcolor{keyword}{template}<\textcolor{keyword}{typename} Probability_ = \textcolor{keywordtype}{double}, \textcolor{keyword}{typename} Generator_ = std::mt19937>}
\DoxyCodeLine{29         \textcolor{keyword}{class }\mbox{\hyperlink{classbn_1_1inference_1_1likelihood__weighting}{likelihood\_weighting}} : \textcolor{keyword}{public} \mbox{\hyperlink{classbn_1_1inference_1_1parallel__inference__algorithm}{parallel\_inference\_algorithm}}<Probability_>}
\DoxyCodeLine{30         \{}
\DoxyCodeLine{31             \textcolor{keyword}{typedef} std::vector<ulong> pattern\_t;}
\DoxyCodeLine{32         \textcolor{keyword}{public}:}
\DoxyCodeLine{33             \textcolor{keyword}{explicit} \mbox{\hyperlink{classbn_1_1inference_1_1likelihood__weighting}{likelihood\_weighting}}(}
\DoxyCodeLine{34                     ulong nsamples,}
\DoxyCodeLine{35                     uint nthreads = 1,}
\DoxyCodeLine{36                     uint seed = 0}
\DoxyCodeLine{37             )}
\DoxyCodeLine{38             : \mbox{\hyperlink{classbn_1_1inference_1_1parallel__inference__algorithm}{parallel\_inference\_algorithm<Probability_>}}(nsamples, nthreads, seed)}
\DoxyCodeLine{39             \{ \};}
\DoxyCodeLine{40 }
\DoxyCodeLine{41         \textcolor{keyword}{private}:}
\DoxyCodeLine{42             \mbox{\hyperlink{classbn_1_1marginal__distribution}{bn::marginal\_distribution<Probability_>}} sample\_step(}
\DoxyCodeLine{43                  \textcolor{keyword}{const} \mbox{\hyperlink{classbn_1_1bayesian__network}{bn::bayesian\_network<Probability_>}} \&\mbox{\hyperlink{namespacebn}{bn}},}
\DoxyCodeLine{44                  ulong nsamples,}
\DoxyCodeLine{45                  uint seed}
\DoxyCodeLine{46             )\textcolor{keyword}{ override}}
\DoxyCodeLine{47 \textcolor{keyword}{            }\{}
\DoxyCodeLine{48                 \mbox{\hyperlink{classbn_1_1marginal__distribution}{bn::marginal\_distribution<Probability_>}} mdistr(\mbox{\hyperlink{namespacebn}{bn}}.begin(), \mbox{\hyperlink{namespacebn}{bn}}.end());}
\DoxyCodeLine{49                 \mbox{\hyperlink{classbn_1_1random__generator}{bn::random\_generator<Probability_, Generator_>}} rnd\_gen(seed);}
\DoxyCodeLine{50 }
\DoxyCodeLine{51                 \textcolor{keywordflow}{for}(ulong i=0; i<nsamples; i++)\{}
\DoxyCodeLine{52                     \textcolor{keyword}{auto} sample\_pair = weighted\_sample(\mbox{\hyperlink{namespacebn}{bn}}, rnd\_gen);}
\DoxyCodeLine{53                     ulong vid = 0;}
\DoxyCodeLine{54                     \textcolor{keyword}{auto} weight = sample\_pair.second;}
\DoxyCodeLine{55 }
\DoxyCodeLine{56                     \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} \& samp : sample\_pair.first)}
\DoxyCodeLine{57                         mdistr[vid++][samp] += weight ;}
\DoxyCodeLine{58                 \}}
\DoxyCodeLine{59                 \textcolor{keywordflow}{return} mdistr;}
\DoxyCodeLine{60             \}}
\DoxyCodeLine{61 }
\DoxyCodeLine{62 }
\DoxyCodeLine{63             std::pair<pattern\_t , Probability_> weighted\_sample(}
\DoxyCodeLine{64                 \textcolor{keyword}{const}  \mbox{\hyperlink{classbn_1_1bayesian__network}{bn::bayesian\_network<Probability_>}} \&\mbox{\hyperlink{namespacebn}{bn}},}
\DoxyCodeLine{65                 \mbox{\hyperlink{classbn_1_1random__generator}{bn::random\_generator<Probability_>}} \& rnd\_gen}
\DoxyCodeLine{66             )}
\DoxyCodeLine{67             \{}
\DoxyCodeLine{68 }
\DoxyCodeLine{69                 Probability_ weight = 1.0;}
\DoxyCodeLine{70                 \textcolor{keyword}{auto} pattern = pattern\_t(\mbox{\hyperlink{namespacebn}{bn}}.number\_of\_variables(), 0.0);}
\DoxyCodeLine{71 }
\DoxyCodeLine{72                 \textcolor{keywordflow}{for}(ulong vid = 0; vid < \mbox{\hyperlink{namespacebn}{bn}}.number\_of\_variables(); ++vid)}
\DoxyCodeLine{73                 \{}
\DoxyCodeLine{74                     \textcolor{keyword}{auto} \& var = \mbox{\hyperlink{namespacebn}{bn}}[vid];}
\DoxyCodeLine{75                     \mbox{\hyperlink{classbn_1_1condition}{bn::condition}} parent\_state;}
\DoxyCodeLine{76 }
\DoxyCodeLine{77                     \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} par : \mbox{\hyperlink{namespacebn}{bn}}.parents\_of(vid))}
\DoxyCodeLine{78                         parent\_state.\mbox{\hyperlink{classbn_1_1condition_aaa01e66363ee3a94e9ec88e7931ffb40}{add}}(}
\DoxyCodeLine{79                                 \mbox{\hyperlink{namespacebn}{bn}}[par].name(),}
\DoxyCodeLine{80                                 pattern[par]}
\DoxyCodeLine{81                         );}
\DoxyCodeLine{82 }
\DoxyCodeLine{83                     \textcolor{keyword}{const} \textcolor{keyword}{auto} \& cpt = var.table();}
\DoxyCodeLine{84                     \textcolor{keywordflow}{if}(var.is\_evidence()) \{}
\DoxyCodeLine{85                         ulong evidence\_state = var.evidence\_state();}
\DoxyCodeLine{86                         weight *= cpt[parent\_state][evidence\_state];}
\DoxyCodeLine{87                         pattern[vid] = evidence\_state;}
\DoxyCodeLine{88                     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{89                         pattern[vid] = make\_random\_by\_weight(}
\DoxyCodeLine{90                                 rnd\_gen.get\_random(),}
\DoxyCodeLine{91                                 cpt[parent\_state]}
\DoxyCodeLine{92                         );}
\DoxyCodeLine{93                     \}}
\DoxyCodeLine{94                 \}}
\DoxyCodeLine{95 }
\DoxyCodeLine{96                 \textcolor{keywordflow}{return} std::make\_pair(pattern, weight);}
\DoxyCodeLine{97             \}}
\DoxyCodeLine{98 }
\DoxyCodeLine{99             uint make\_random\_by\_weight(}
\DoxyCodeLine{100                     \textcolor{keyword}{const} Probability_ p,}
\DoxyCodeLine{101                     \textcolor{keyword}{const} std::vector<Probability_> \& weight}
\DoxyCodeLine{102             )}
\DoxyCodeLine{103             \{}
\DoxyCodeLine{104                 BAYLIB\_ASSERT(0.0 <= p \&\& p <= 1.0,}
\DoxyCodeLine{105                               \textcolor{stringliteral}{"{}Invalid probability value"{}}}
\DoxyCodeLine{106                               \textcolor{stringliteral}{"{} not included in [0,1]"{}},}
\DoxyCodeLine{107                               std::logic\_error);}
\DoxyCodeLine{108 }
\DoxyCodeLine{109                 Probability_ total = 0.0;}
\DoxyCodeLine{110                 \textcolor{keywordflow}{for}(uint i = 0; i < weight.size(); ++i)}
\DoxyCodeLine{111                 \{}
\DoxyCodeLine{112                     \textcolor{keyword}{auto} \textcolor{keyword}{const} old\_total = total;}
\DoxyCodeLine{113                     total += weight[i];}
\DoxyCodeLine{114                     \textcolor{keywordflow}{if}(old\_total <= p \&\& p < total)}
\DoxyCodeLine{115                     \{}
\DoxyCodeLine{116                         \textcolor{keywordflow}{return} i;}
\DoxyCodeLine{117                     \}}
\DoxyCodeLine{118                 \}}
\DoxyCodeLine{119 }
\DoxyCodeLine{120                 \textcolor{keywordflow}{return} weight.size() -\/ 1;}
\DoxyCodeLine{121             \}}
\DoxyCodeLine{122 }
\DoxyCodeLine{123         \};}
\DoxyCodeLine{124     \} \textcolor{comment}{// namespace inference}}
\DoxyCodeLine{125 \} \textcolor{comment}{// namespace bn}}
\DoxyCodeLine{126 }
\DoxyCodeLine{127 \textcolor{preprocessor}{\#endif }\textcolor{comment}{//BAYLIB\_LIKELIHOOD\_WEIGHTING\_HPP}}

\end{DoxyCode}
